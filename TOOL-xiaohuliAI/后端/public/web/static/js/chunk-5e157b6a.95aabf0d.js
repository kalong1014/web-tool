(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-5e157b6a"],{"114b":function(t,e,s){"use strict";s.d(e,"a",(function(){return o}));s("a7fa"),s("f17d"),s("cac0"),s("0f4e"),s("c9c8"),s("c565"),s("96bb");var i=s("5f87");function o(){var t=this;this.apiUrl="/web.php/chat/sendText",this.onMessage=function(){},this.onError=function(){},this.onFinish=function(){},this.fetchCtrl="",this.outputStacks=[],this.outputSI=0,this.request=function(e){t.fetchCtrl=new AbortController;var s=new Headers;s.append("Content-Type","application/json"),s.append("X-token",Object(i["d"])()||""),s.append("X-site",Object(i["a"])()||""),fetch(this.apiUrl,{method:"POST",headers:s,body:JSON.stringify(e),signal:t.fetchCtrl.signal}).then((function(e){if(e.ok){var s=e.body.getReader(),i=new TextDecoder("utf-8");o(),t.startOutput()}else t.onError(e.statusText);function o(){s.read().then((function(e){var s=e.done,n=e.value;if(s)return t.stopOutput(),void t.onFinish();if(n){var a=i.decode(n);if(a){if(-1!==a.indexOf("[error]"))return t.stopOutput(),t.onError(a.replace("[error]","")),void t.onFinish();for(var l=0;l<a.length;l++)t.outputStacks.push(a[l])}}o()}))}})).catch((function(e){"AbortError"===e.name?(t.stopOutput(),t.onFinish(),console.log("请求已被取消")):console.log("网络错误",e)}))},this.startOutput=function(){t.stopOutput(),t.outputSI=setInterval((function(){t.outputStacks.length>0&&t.onMessage(t.outputStacks.shift())}),24)},this.stopOutput=function(){t.outputSI&&clearInterval(t.outputSI),t.outputSI=0,t.outputStacks.length>0&&t.onMessage(t.outputStacks.join("")),t.outputStacks=[]},this.stop=function(){t.fetchCtrl&&(t.fetchCtrl.abort(),t.fetchCtrl=null),t.stopOutput(),t.onFinish()}}},d474:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"module-novel"},[s("div",{staticClass:"sub-sidebar"},[s("div",{staticClass:"module-header"},[s("div",[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_mod_novel"}}),s("span",[t._v("长篇写作")])],1),s("el-button",{staticClass:"item",attrs:{size:"small",type:"primary",plain:"",icon:"el-icon-circle-plus"},on:{click:function(e){return t.showNovelForm("")}}},[t._v("创建新作品")])],1),s("div",{staticClass:"module-body"},[s("el-scrollbar",{attrs:{"wrap-class":"scrollbar-wrapper"}},[s("div",{staticClass:"novel-list"},[t._l(t.novelList,(function(e){return s("div",{staticClass:"novel-item",class:{active:t.activeNovelId===e.novel_id},on:{click:function(s){return t.switchNovel(e.novel_id)}}},[s("div",{staticClass:"item-header"},[0===e.count_finished?s("el-tag",{attrs:{type:"info",size:"mini"}},[t._v("未开始")]):e.count_finished<e.count_total?s("el-tag",{attrs:{type:"warning",size:"mini"}},[t._v("未完成")]):e.count_finished>=e.count_total?s("el-tag",{attrs:{type:"success",size:"mini"}},[t._v("已完成")]):t._e(),s("span",{staticClass:"title"},[t._v(t._s(e.title))])],1),s("div",{staticClass:"item-body"},[s("div",{staticClass:"count"},[s("span",[t._v("章节 "+t._s(e.count_finished)+" / "+t._s(e.count_total))]),s("span",{staticClass:"line"},[t._v("|")]),s("span",[t._v("已写 "+t._s(e.words)+" 字")])])]),s("div",{staticClass:"item-footer"},[s("div",{staticClass:"time"},[t._v(" "+t._s(e.create_time)+" ")]),s("div",{staticClass:"ops",on:{click:function(t){t.stopPropagation()}}},[s("el-dropdown",{attrs:{trigger:"click"}},[s("span",{staticClass:"el-dropdown-link"},[s("i",{staticClass:"btn-dropdown el-icon-more"})]),s("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[s("el-dropdown-item",{nativeOn:{click:function(s){return s.stopPropagation(),t.showNovelForm(e.novel_id)}}},[t._v(t._s(t._f("lang")("编辑")))]),s("el-dropdown-item",{staticClass:"text-danger",nativeOn:{click:function(s){return s.stopPropagation(),t.delNovel(e.novel_id)}}},[t._v(t._s(t._f("lang")("删除")))])],1)],1)],1)])])})),t.hasMore?s("div",{staticClass:"load-more",on:{click:t.getNovelList}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_load_more"}}),s("span",[t._v("加载更多")])],1):s("div",{staticClass:"no-more"},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_load_more"}}),s("span",[t._v("到底了~")])],1)],2)])],1)]),s("div",{staticClass:"main-wrapper"},[t.activeNovelId?s("task-list",{attrs:{novel_id:t.activeNovelId},on:{showNovelForm:t.showNovelForm,setNovelInfo:t.setNovelInfo,setWriting:t.setWriting}}):s("welcome",{attrs:{tips:t.novelList.length>0?"请选择任务组":"请先创建任务组"}})],1),t.novelForm?s("div",[s("el-dialog",{attrs:{"custom-class":"my-dialog",title:t._f("lang")(t.novelForm.novel_id?"作品设置":"创建新作品"),width:"780px",visible:!0,"close-on-click-modal":!1,"append-to-body":!0,"before-close":t.closeNovelForm}},[s("el-form",{ref:"form",staticStyle:{padding:"20px 0"},attrs:{model:t.novelForm,"label-width":"100px"}},[s("el-form-item",{attrs:{label:t._f("lang")("作品名称")}},[s("el-input",{staticStyle:{width:"400px"},attrs:{placeholder:t._f("lang")("请输入作品名称"),size:"normal"},model:{value:t.novelForm.title,callback:function(e){t.$set(t.novelForm,"title",e)},expression:"novelForm.title"}})],1),s("el-form-item",{attrs:{label:t._f("lang")("AI通道")}},[s("el-select",{attrs:{placeholder:"请选择"},model:{value:t.novelForm.ai,callback:function(e){t.$set(t.novelForm,"ai",e)},expression:"novelForm.ai"}},t._l(t.aiList,(function(t){return s("el-option",{attrs:{label:t.alias,value:t.name}})})),1),t.isGpt4(t.novelForm.ai)?s("div",{staticClass:"text-primary"},[t.priceSetting.text40>0?s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("高级通道，每章节消耗 "+t._s(t.priceSetting.text40)+" "+t._s(t.priceSetting.title)),t.priceSetting.text40_vip?s("span",[t._v("（会员免费）")]):t._e()]):s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("高级通道，免费使用")])]):s("div",{staticClass:"text-primary"},[t.priceSetting.text35>0?s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("每章节消耗 "+t._s(t.priceSetting.text35)+" "+t._s(t.priceSetting.title)),t.priceSetting.text35_vip?s("span",[t._v("（会员免费）")]):t._e()]):s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("免费使用")])])],1),s("el-form-item",{attrs:{label:t._f("lang")("写作要求")}},[s("el-input",{staticStyle:{width:"580px"},attrs:{type:"textarea",rows:4,placeholder:t._f("lang")("输入您对作品的要求"),size:"normal"},model:{value:t.novelForm.prompt,callback:function(e){t.$set(t.novelForm,"prompt",e)},expression:"novelForm.prompt"}})],1),s("el-form-item",{attrs:{label:t._f("lang")("作品大纲")}},[s("el-input",{ref:"sketchInput",staticStyle:{width:"580px"},attrs:{type:"textarea",rows:10,placeholder:t._f("lang")("作品大纲尽量详细，建议字数不超过3000"),size:"normal"},model:{value:t.novelForm.sketch,callback:function(e){t.$set(t.novelForm,"sketch",e)},expression:"novelForm.sketch"}}),s("p",[t.sketchWriting?s("a",{staticClass:"text-primary",staticStyle:{cursor:"pointer",display:"flex","align-items":"center",width:"100px"},on:{click:t.stopMakeSketch}},[s("svg-icon",{staticStyle:{"font-size":"20px"},attrs:{"icon-class":"ic_stop"}}),s("span",{staticStyle:{"font-size":"16px","margin-left":"5px"}},[t._v("停止生成")])],1):s("a",{staticClass:"text-primary",staticStyle:{cursor:"pointer",display:"flex","align-items":"center",width:"100px"},on:{click:t.showMakeSketch}},[s("svg-icon",{staticStyle:{"font-size":"20px"},attrs:{"icon-class":"ic_write"}}),s("span",{staticStyle:{"font-size":"16px","margin-left":"5px"}},[t._v("生成大纲")])],1)])],1)],1),t.makeSketchShow?s("div",[s("el-dialog",{attrs:{"custom-class":"my-dialog",title:t._f("lang")("生成大纲"),width:"620px",visible:!0,"close-on-click-modal":!1,"append-to-body":!0,"before-close":t.closeMakeSketch}},[s("el-form",{ref:"form",staticStyle:{padding:"20px 0"},attrs:{"label-width":"100px"}},[s("el-form-item",{attrs:{label:t._f("lang")("作品概要")}},[s("el-input",{staticStyle:{width:"430px"},attrs:{id:"sketch",type:"textarea",rows:8,placeholder:t._f("lang")("简要描述作品的大概内容"),size:"normal"},model:{value:t.novelForm.overview,callback:function(e){t.$set(t.novelForm,"overview",e)},expression:"novelForm.overview"}}),t.isGpt4(t.novelForm.ai)?s("div",{staticClass:"text-primary"},[t.priceSetting.text40>0?s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("消耗 "+t._s(t.priceSetting.text40)+" "+t._s(t.priceSetting.title)),t.priceSetting.text40_vip?s("span",[t._v("（会员免费）")]):t._e()]):t._e()]):s("div",{staticClass:"text-primary"},[t.priceSetting.text35>0?s("p",{staticStyle:{"line-height":"24px",margin:"5px 0","font-size":"16px"}},[t._v("消耗 "+t._s(t.priceSetting.text35)+" "+t._s(t.priceSetting.title)),t.priceSetting.text35_vip?s("span",[t._v("（会员免费）")]):t._e()]):t._e()])],1)],1),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"default",icon:"el-icon-close",size:"small"},on:{click:t.closeMakeSketch}},[t._v(t._s(t._f("lang")("取 消")))]),s("el-button",{attrs:{type:"primary",icon:"el-icon-check",size:"small"},on:{click:t.makeSketch}},[t._v(t._s(t._f("lang")("开始生成")))])],1)],1)],1):t._e(),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"default",icon:"el-icon-close",size:"small"},on:{click:t.closeNovelForm}},[t._v(t._s(t._f("lang")("取 消")))]),s("el-button",{attrs:{type:"primary",icon:"el-icon-check",size:"small"},on:{click:t.saveNovelInfo}},[t._v(t._s(t._f("lang")("确 定")))])],1)],1)],1):t._e()])},o=[],n=s("e089"),a=(s("58d4"),s("c565"),s("233b"),s("cb2e"),s("6db4")),l=s("b775");function r(t){return Object(l["a"])({url:"/novel/getNovelList",method:"post",data:t})}function c(t){return Object(l["a"])({url:"/novel/getNovelInfo",method:"post",data:t})}function v(t){return Object(l["a"])({url:"/novel/saveNovelInfo",method:"post",data:t})}function p(t){return Object(l["a"])({url:"/novel/delNovel",method:"post",data:t})}function d(t){return Object(l["a"])({url:"/novel/getTaskList",method:"post",data:t})}function h(t){return Object(l["a"])({url:"/novel/delTask",method:"post",data:t})}function m(t){return Object(l["a"])({url:"/novel/saveTask",method:"post",data:t})}function u(t){return Object(l["a"])({url:"/novel/delAllTask",method:"post",data:t})}var f=s("ca00"),g=s("114b"),k=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"task-empty"},[s("div",{staticClass:"box-empty"},[s("p",{staticClass:"icon"},[s("svg-icon",{attrs:{"icon-class":"ic_empty"}})],1),s("p",{staticClass:"tips"},[t._v(t._s(t.tips))])])])},_=[],x={props:{tips:{type:String,default:"请先添加或导入任务"}}},w=x,b=s("76b2"),y=Object(b["a"])(w,k,_,!1,null,null,null),I=y.exports,F=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"box-task"},[s("div",{staticClass:"task-toolbar"},[s("div",{staticStyle:{width:"550px",display:"flex","justify-content":"space-between","align-items":"center"}},[s("div",[s("el-button",{attrs:{size:"small",icon:"el-icon-plus",type:"primary"},on:{click:function(e){return t.showTaskForm(null)}}},[t._v("添加章节")]),s("el-button",{attrs:{size:"small",icon:"el-icon-upload2",type:"default"},on:{click:t.showImportForm}},[t._v("批量导入章节")])],1),s("div",[t.taskList&&t.taskList.length>0?s("el-button",{attrs:{size:"small",type:"default",loading:t.taskRunning},on:{click:t.startAllTask}},[t.taskRunning?t._e():s("svg-icon",{attrs:{"icon-class":"ic_play"}}),t._v(" 全部开始 ")],1):t._e()],1)]),s("div",[s("el-button",{attrs:{size:"small",icon:"el-icon-s-tools",type:"default"},on:{click:t.openSetting}},[t._v("作品设置")]),s("el-button",{attrs:{size:"small",icon:"el-icon-brush",type:"default"},on:{click:t.delAllTask}},[t._v("清空章节列表")]),s("el-button",{attrs:{size:"small",icon:"el-icon-download",type:"default"},on:{click:t.exportZip}},[t._v("打包下载")])],1)]),t.taskList&&t.taskList.length>0?s("div",{staticClass:"task-main"},[s("el-scrollbar",{ref:"task-list",staticClass:"task-list",attrs:{"wrap-class":"scrollbar-wrapper"}},t._l(t.taskList,(function(e,i){return s("div",{staticClass:"task-item",class:{active:t.activeIndex>=0&&t.taskList[t.activeIndex].id===e.id},on:{click:function(e){return t.switchTask(i)}}},[s("div",{staticClass:"td state"},[i===t.activeIndex&&t.writing?s("el-tag",{attrs:{type:"warning",size:"small"}},[t._v("生成中")]):1===e.state?s("el-tag",{attrs:{type:"success",size:"small"}},[t._v("已完成")]):s("el-tag",{attrs:{type:"info",size:"small"}},[t._v("未开始")])],1),s("div",{staticClass:"td title"},[s("p",[t._v(t._s(e.title))]),s("p",{staticClass:"subtitle"},[t._v(t._s(e.overview||"无概要"))])]),s("div",{staticClass:"ops"},[s("el-dropdown",{attrs:{trigger:"click"}},[s("span",{staticClass:"el-dropdown-link"},[s("i",{staticClass:"btn-dropdown el-icon-more"})]),s("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[s("el-dropdown-item",{nativeOn:{click:function(e){return e.stopPropagation(),t.showTaskForm(i)}}},[t._v(t._s(t._f("lang")("编辑")))]),s("el-dropdown-item",{staticClass:"text-danger",nativeOn:{click:function(e){return e.stopPropagation(),t.delTask(i)}}},[t._v(t._s(t._f("lang")("删除")))])],1)],1)],1)])})),0),s("div",{staticClass:"task-chat box-chat"},[s("el-scrollbar",{ref:"chat-list",attrs:{"wrap-class":"scrollbar-wrapper"}},[t.activeIndex>=0?s("div",{staticClass:"chat-msg style-word"},[s("div",{staticClass:"msg-list"},[s("div",{staticClass:"msg-row row-user"},[s("div",{staticClass:"msg-item"},[s("div",{staticClass:"text markdown-body",domProps:{innerHTML:t._s(t.textToHtml(t.taskList[t.activeIndex].title))}})]),s("div",{staticStyle:{clear:"both"}})]),t.taskList[t.activeIndex].overview?s("div",{staticClass:"msg-row row-user"},[t.taskList[t.activeIndex].overview?s("div",{staticClass:"msg-item",staticStyle:{"padding-top":"0","max-height":"max-content"}},[s("div",{staticClass:"overview",domProps:{innerHTML:t._s(t.textToHtml("本章概要："+t.taskList[t.activeIndex].overview))}})]):t._e()]):t._e(),t.writing||t.taskList[t.activeIndex].writingText?s("div",{staticClass:"msg-row row-ai"},[s("div",{staticClass:"msg-item"},[s("div",{staticClass:"text markdown-body"},[s("Markdown",{attrs:{text:t.writingText,writing:!(!t.writing&&!t.writingText),"show-count":!0}}),s("div",{staticClass:"tools"},[s("span",{staticClass:"btn text-primary",on:{click:t.stopRequest}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_stop"}}),t._v(t._s(t._f("lang")("停止生成")))],1),s("span",{staticClass:"btn text-primary",staticStyle:{cursor:"default"}},[t._v("字数 "+t._s(t.writingText.length))])])],1)])]):t.taskList[t.activeIndex].response?s("div",{staticClass:"msg-row row-ai"},[s("div",{staticClass:"msg-item"},[s("div",{staticClass:"text markdown-body"},[s("Markdown",{attrs:{id:"message-"+t.taskList[t.activeIndex].id,text:t.taskList[t.activeIndex].response,"show-tools":!1,"show-count":!0,"show-ppt":t.isPPT(t.taskList[t.activeIndex].message),"show-table":t.isTable(t.taskList[t.activeIndex].message),index:t.activeIndex},on:{retry:t.retryRequest}}),t.taskList[t.activeIndex].response?s("div",{staticClass:"tools"},[s("span",{staticClass:"btn text-primary",on:{click:t.requestAI}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_play"}}),t._v(t._s(t._f("lang")("继续写")))],1),s("span",{staticClass:"btn text-primary",on:{click:t.copyText}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_copy"}}),t._v(t._s(t._f("lang")("复制内容")))],1),s("span",{staticClass:"btn text-primary",staticStyle:{cursor:"default"}},[t._v("字数 "+t._s(t.taskList[t.activeIndex].response.length))]),s("div",{staticStyle:{float:"right"}},[s("span",{staticClass:"btn text-primary",attrs:{title:t._f("lang")("导出Word")},on:{click:t.exportWord}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_word"}}),t._v(t._s(t._f("lang")("导出Word")))],1),s("span",{staticClass:"btn text-primary",attrs:{title:t._f("lang")("编辑")},on:{click:function(e){return t.showTaskForm(t.activeIndex)}}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_edit"}}),t._v(t._s(t._f("lang")("编辑")))],1),s("span",{staticClass:"btn text-primary",staticStyle:{"margin-right":"0"},attrs:{title:t._f("lang")("重新写")},on:{click:t.retryRequest}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_retry"}}),t._v(t._s(t._f("lang")("重新写")))],1)])]):t._e()],1)]),s("div",{staticStyle:{clear:"both"}})]):s("div",{staticClass:"msg-row row-ai"},[s("div",{staticClass:"msg-item"},[s("div",{staticClass:"text markdown-body"},[s("span",{staticClass:"btn text-primary",staticStyle:{cursor:"pointer"},on:{click:t.requestAI}},[s("svg-icon",{staticClass:"icon",attrs:{"icon-class":"ic_play"}}),t._v(t._s(t._f("lang")("开始生成")))],1)])])])])]):t._e()])],1)],1):t._e(),t.taskList&&0!==t.taskList.length?t._e():s("welcome",{attrs:{tips:"请先添加或导入章节"}}),t.taskForm?s("div",[s("el-dialog",{attrs:{"custom-class":"my-dialog",title:t._f("lang")(t.taskForm.id?"编辑":"添加章节"),width:"880px",visible:!0,"close-on-click-modal":!1,"append-to-body":!0,"before-close":t.closeTaskForm}},[s("el-form",{ref:"form",staticStyle:{padding:"20px 0"},attrs:{model:t.taskForm,"label-width":"90px"}},[s("el-form-item",{attrs:{label:t._f("lang")("章节标题")}},[s("el-input",{staticStyle:{width:"320px"},attrs:{type:"text",placeholder:"请输入章节标题",size:"normal"},model:{value:t.taskForm.title,callback:function(e){t.$set(t.taskForm,"title",e)},expression:"taskForm.title"}})],1),s("el-form-item",{attrs:{label:t._f("lang")("本章概要")}},[s("el-input",{staticStyle:{width:"700px"},attrs:{type:"textarea",rows:5,placeholder:"请输入本章大纲或细纲，建议不超过1000字",size:"normal"},model:{value:t.taskForm.overview,callback:function(e){t.$set(t.taskForm,"overview",e)},expression:"taskForm.overview"}})],1),s("el-form-item",{attrs:{label:t._f("lang")("本章内容")}},[s("el-input",{staticStyle:{width:"700px"},attrs:{type:"textarea",rows:15,placeholder:"可留空",size:"normal"},model:{value:t.taskForm.response,callback:function(e){t.$set(t.taskForm,"response",e)},expression:"taskForm.response"}}),s("p",{staticClass:"tips"},[t._v("注：内容可以留空从头生成，也可以写一段开头，由AI续写")])],1)],1),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"default",icon:"el-icon-close",size:"small"},on:{click:t.closeTaskForm}},[t._v(t._s(t._f("lang")("取 消")))]),s("el-button",{attrs:{type:"primary",icon:"el-icon-check",size:"small"},on:{click:t.saveTask}},[t._v(t._s(t._f("lang")("提 交")))])],1)],1)],1):t._e(),t.importForm?s("div",[s("el-dialog",{attrs:{"custom-class":"my-dialog",title:t._f("lang")("批量导入章节"),width:"400px",visible:!0,"close-on-click-modal":!0,"append-to-body":!0,"before-close":t.closeImportForm}},[s("div",{staticStyle:{"text-align":"center"}},[s("p",[s("el-upload",{staticClass:"btn-import",attrs:{"before-upload":t.checkExcelFile,"on-success":t.importTaskSuccess,"show-file-list":!1,action:"/web.php/novel/importTask",data:{novel_id:this.novel_id}}},[s("el-button",{attrs:{type:"primary",icon:"el-icon-upload2",size:"large"}},[t._v(t._s(t._f("lang")("选择 Excel 文件")))])],1)],1),s("p",{staticStyle:{"font-size":"14px",margin:"30px 0"}},[s("a",{staticClass:"text-primary",attrs:{href:"/static/chapter.xlsx"}},[s("span",{staticStyle:{"margin-left":"10px"}},[t._v("下载导入模板")])])])])])],1):t._e(),t.zipExporting?s("div",{staticStyle:{opacity:"0"}},t._l(t.taskList,(function(e,i){return s("div",[1===e.state&&e.response?s("Markdown",{attrs:{id:"zipHtml-"+e.id,text:e.response}}):t._e()],1)})),0):t._e()],1)},C=[],S=(s("c9c8"),s("61b2")),L=s("fcf0"),T=s.n(L),$=s("0079"),z=s.n($),N=s("4e9e"),O=s.n(N),j=new g["a"],M={name:"Novel",components:{Markdown:S["c"],welcome:I},props:{novel_id:{type:String,default:""},ai:{type:String,default:""}},data:function(){return{novelInfo:null,activeIndex:-1,taskList:[],taskForm:null,taskRunning:!1,importForm:null,writing:!1,writingText:"",zipExporting:!1}},computed:Object(n["a"])({},Object(a["b"])(["priceSetting"])),watch:{novel_id:{immediate:!0,handler:function(){this.activeIndex=-1,this.getTaskList()}},writing:function(){this.$emit("setWriting",this.writing)}},methods:{requestAI:function(){if(!this.writing&&!this.writingText){this.writing=!0,this.writingText=this.taskList[this.activeIndex].response?this.taskList[this.activeIndex].response:"",this.scrollBottom();var t=this;j.onMessage=function(e){e&&(t.writingText+=e,t.scrollBottom())},j.onError=function(e){t.writing=!1,t.writingText="",t.taskRunning=!1,-1!==e.indexOf("请登录")?(t.$modals.showLogin(),setTimeout((function(){t.$message.error(t.$lang(e))}),500)):-1!==e.indexOf("请充值")?(t.novelInfo&&Object(f["a"])(t.novelInfo.ai)?t.priceSetting.text40_vip?t.$modals.showPay("vip"):t.$modals.showPay("point"):t.$modals.showPay("vip"),setTimeout((function(){t.$message.error(t.$lang(e))}),500)):t.$alert(e,"系统提示")},j.onFinish=function(){t.writingText&&(t.taskList[t.activeIndex].response=t.writingText,t.taskList[t.activeIndex].state=1),t.writing=!1,t.writingText="",t.scrollBottom(),t.taskRunning&&setTimeout((function(){t.startAllTask()}),1e3)},j.request({novel_id:t.novel_id,task_id:t.taskList[t.activeIndex].id,message:this.taskList[this.activeIndex].response})}},retryRequest:function(){this.writing=!1,this.writingText="",this.taskList[this.activeIndex].response="",this.taskList[this.activeIndex].state=0,this.requestAI()},stopRequest:function(){var t=this,e=this.writingText;this.writing=!1,this.taskRunning=!1,j.stop(),setTimeout((function(){e||(t.taskList[t.activeIndex].response="",t.taskList[t.activeIndex].state=0)}),50)},scrollBottom:function(){var t=this;this.$nextTick((function(){if(t.$refs["chat-list"]){var e=t.$refs["chat-list"].wrap;setTimeout((function(){e.scrollTop=e.scrollHeight}),200)}}))},scrollTaskToView:function(){var t=this;this.$nextTick((function(){if(t.$refs["task-list"]){var e=t.$refs["task-list"].wrap;setTimeout((function(){var s=48,i=3*s,o=t.activeIndex*s,n=parseInt(e.scrollTop),a=e.offsetHeight;o<n?e.scrollTop=o-i:o-a+s>n&&(e.scrollTop=o-a+i)}),200)}}))},startAllTask:function(){if(this.writing)this.$message.error("已有任务正在运行中");else{for(var t=this.taskList,e=0;e<t.length;e++)if(0===t[e].state)return this.switchTask(e),this.scrollTaskToView(),this.taskRunning=!0,this.taskList[e].response="",void this.requestAI();this.taskRunning=!1,this.$message.success("所有任务已执行完毕")}},openSetting:function(){this.$emit("showNovelForm",this.novel_id)},getTaskList:function(){var t=this;this.novel_id?d({novel_id:this.novel_id}).then((function(e){t.taskList=e.data,t.taskList.length>0&&t.switchTask(0),t.getNovelInfo()})).catch((function(e){403===e.errno&&t.$modals.showLogin()})):this.taskList=[]},switchTask:function(t){this.writing?this.$message.error("任务执行中，请停止后切换"):this.activeIndex=t},tableIndex:function(t){return t+=1,t<10&&(t="0"+t),t},showTaskForm:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null===t)this.taskForm={novel_id:this.novel_id,title:"",overview:""};else{if(this.taskRunning&&this.activeIndex===t)return void this.$message.error("请先停止任务");var e=this.taskList[t];this.taskForm={novel_id:this.novel_id,task_id:e.id,title:e.title,overview:e.overview,response:e.response}}},closeTaskForm:function(){this.taskForm=null},delTask:function(t){var e=this;if(this.taskRunning&&this.activeIndex===t)this.$message.error("请先停止任务");else{var s=this.taskList[t].id;this.$confirm("删除后不可恢复，确认吗?","提示",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((function(){h({novel_id:e.novel_id,task_id:s}).then((function(){e.activeIndex===e.taskList.length-1&&e.activeIndex--,e.taskList.splice(t,1),e.getNovelInfo()})).catch((function(t){403===t.errno&&e.$modals.showLogin()}))}))}},getNovelInfo:function(){var t=this;c({novel_id:this.novel_id}).then((function(e){t.novelInfo=e.data,t.$emit("setNovelInfo",t.novelInfo)})).catch((function(e){403===e.errno&&t.$modals.showLogin()}))},saveTask:function(){var t=this;m(this.taskForm).then((function(e){t.$message.success(e.message),t.taskForm.task_id?(t.taskList[t.activeIndex].title=t.taskForm.title,t.taskList[t.activeIndex].overview=t.taskForm.overview,t.taskList[t.activeIndex].response=t.taskForm.response):(t.taskList.push({id:e.data.task_id,title:t.taskForm.title,overview:t.taskForm.overview,response:"",state:0}),-1===t.activeIndex&&(t.activeIndex=0),t.getNovelInfo()),t.closeTaskForm()})).catch((function(e){403===e.errno&&t.$modals.showLogin()}))},showImportForm:function(){this.taskRunning?this.$message.error("请先停止任务"):this.importForm={}},closeImportForm:function(){this.importForm=null},checkExcelFile:function(t){if("application/vnd.ms-excel"!==t.type&&"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"!==t.type)return this.$message.error(this.$lang("请上传Excel文件")),!1},importTaskSuccess:function(t,e,s){t.errno>0?this.$message.error(t.message):(this.getTaskList(),this.closeImportForm(),this.$message.success(t.message))},delAllTask:function(){var t=this;this.$confirm("删除后不可恢复，确认吗?","提示",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((function(){u({novel_id:t.novel_id}).then((function(e){t.activeIndex=-1,t.taskList=[],t.getNovelInfo(),t.$message.success(e.message)}))})).catch((function(e){403===e.errno&&t.$modals.showLogin()}))},exportZip:function(){var t=this,e=new T.a,s=0;this.zipExporting=!0,this.$loading({fullscreen:!0,lock:!0,text:"正在打包",background:"rgba(0,0,0,0.3)",customClass:"my-loading"}),this.$nextTick((function(){for(var i=0;i<t.taskList.length;i++){var o=t.taskList[i];if(1===o.state&&o.response){t.zipExportHtml=o.response;var n='<div style="font-size: 12pt;">'+Object(f["d"])(o.response)+"</div>";n="<p><center><h2>"+o.title+"</h2></center></p>"+n,e.file(o.title.substr(0,30)+".docx",z.a.asBlob(n)),s++}}t.zipExporting=!1,t.$loading().close(),0!==s?e.generateAsync({type:"blob"}).then((function(t){O.a.saveAs(t,"data.zip")})):t.$message.error("请先生成内容")}))},copyText:function(t){var e=this,s=this.taskList[this.activeIndex].response;e.$copyText(s).then((function(){e.$message.success(e.$lang("已复制"))}),(function(){e.$message.error(e.$lang("复制失败，请重试"))}))},exportWord:function(){var t=this.taskList[this.activeIndex],e='<div style="font-size: 12pt;">'+Object(f["d"])(t.response)+"</div>";e="<p><center><h2>"+t.title+"</h2></center></p>"+e;var s=z.a.asBlob(e);O.a.saveAs(s,t.title.substr(0,30)+".docx")},textToHtml:f["d"],isPPT:f["b"],isTable:f["c"]}},A=M,P=Object(b["a"])(A,F,C,!1,null,null,null),E=P.exports,R=new g["a"],W={name:"Novel",components:{taskList:E,welcome:I},data:function(){return{novelList:[],page:1,pagesize:10,hasMore:!1,activeNovelId:"",novelForm:null,writing:!1,makeSketchShow:!1,sketchWriting:!1}},computed:Object(n["a"])({},Object(a["b"])(["aiList","priceSetting"])),mounted:function(){this.getNovelList()},methods:{getNovelList:function(){var t=this;r({page:this.page,pagesize:this.pagesize}).then((function(e){t.novelList=t.novelList.concat(e.data.list),1===t.page&&t.novelList.length>0&&t.switchNovel(e.data.list[0].novel_id),t.hasMore=t.novelList.length<e.data.count,t.page++})).catch((function(e){403===e.errno&&t.$modals.showLogin()}))},setNovelInfo:function(t){var e=this.getNovelIndex(t.novel_id);this.novelList[e].ai=t.ai,this.novelList[e].title=t.title,this.novelList[e].prompt=t.prompt,this.novelList[e].count_finished=t.count_finished,this.novelList[e].count_total=t.count_total,t.create_time&&(this.novelList[e].create_time=t.create_time)},setWriting:function(t){this.writing=t},showNovelForm:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";e?c({novel_id:e}).then((function(s){t.novelForm={novel_id:e,ai:s.data.ai,title:s.data.title,prompt:s.data.prompt,overview:s.data.overview,sketch:s.data.sketch}})):this.novelForm={ai:this.aiList.length>0?this.aiList[0].name:"",title:"",prompt:"",overview:"",sketch:""}},closeNovelForm:function(){this.novelForm=null},delNovel:function(t){var e=this,s=this.getNovelIndex(t);this.activeNovelId===t&&this.writing?this.$message.error("请先停止任务"):this.$confirm("删除后不可恢复，确认删除吗?","提示",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning"}).then((function(){p({novel_id:t}).then((function(i){e.novelList.splice(s,1),e.activeNovelId===t&&(e.activeNovelId=""),e.$forceUpdate()})).catch((function(t){403===t.errno&&e.$modals.showLogin()}))}))},getNovelIndex:function(t){for(var e=-1,s=this.novelList,i=0;i<s.length;i++)if(s[i].novel_id===t){e=i;break}return e},saveNovelInfo:function(){var t=this;this.novelForm.ai?v(this.novelForm).then((function(e){if(t.novelForm.novel_id){var s=t.getNovelIndex(t.novelForm.novel_id);t.novelList[s]=e.data}else t.novelList.unshift(e.data),t.writing||t.switchNovel(e.data.novel_id);t.$message.success(e.message),t.closeNovelForm()})).catch((function(e){403===e.errno&&t.$modals.showLogin()})):this.$message.error("请选择AI通道")},switchNovel:function(t){this.activeNovelId!==t&&(this.writing?this.$message.error("请先停止任务"):this.activeNovelId=t)},makeSketch:function(){if(!this.sketchWriting){var t="正在生成...",e=this.novelForm.sketch,s=this.novelForm.ai;if(s){var i=this.novelForm.overview;if(i){this.novelForm.title&&(i="作品名称："+this.novelForm.title+"\n"+i),this.novelForm.sketch=t,this.$refs.sketchInput.focus(),this.sketchWriting=!0,this.closeMakeSketch();var o=this;R.onMessage=function(e){e&&(o.novelForm.sketch===t&&(o.novelForm.sketch=""),o.novelForm.sketch+=e)},R.onError=function(t){o.sketchWriting=!1,o.novelForm.sketch=e,-1!==t.indexOf("请登录")?(o.$modals.showLogin(),setTimeout((function(){o.$message.error(o.$lang(t))}),500)):-1!==t.indexOf("请充值")?(Object(f["a"])(s)?o.priceSetting.text40_vip?o.$modals.showPay("vip"):o.$modals.showPay("point"):o.$modals.showPay("vip"),setTimeout((function(){o.$message.error(o.$lang(t))}),500)):o.$alert(t,"系统提示")},R.onFinish=function(){o.novelForm.sketch===t&&(o.novelForm.sketch=""),o.sketchWriting=!1},R.request({tool:"sketch",ai:s,message:i})}else this.$message.error("请输入作品概要")}else this.$message.error("请选择AI通道")}},stopMakeSketch:function(){this.sketchWriting=!1,R.stop()},showMakeSketch:function(){this.makeSketchShow=!0},closeMakeSketch:function(){this.makeSketchShow=!1},isGpt4:f["a"],textToHtml:f["d"],isPPT:f["b"],isTable:f["c"]}},q=W,B=Object(b["a"])(q,i,o,!1,null,null,null);e["default"]=B.exports}}]);